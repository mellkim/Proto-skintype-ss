<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Genetic Skin Analysis â€“ Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-slate-50 min-h-screen">
    <div id="root" class="p-4 md:p-6"></div>

    <script type="text/babel" data-presets="react">
        const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbx2L7xgnQO8a3Hxi9LPAgm7AFyzaIO04jHip4fuM5T_mFV212BgZd9lHHAOZYzTzghW/exec';
        const SHEETS_TOKEN = 'skincare_app_2025_XyZ9!aB3';   // Code.gs ì˜ SECRET_TOKENê³¼ ë™ì¼

        const { useState, useEffect } = React;

        /* ---------- ì•„ì´ì½˜/ê³µí†µ ì»´í¬ë„ŒíŠ¸(ê¸°ì¡´ ìœ ì§€) ---------- */
        const Icon = ({ children, className = '' }) => (<span className={'inline-block align-middle ' + className}>{children}</span>);
        const I = {
            plus: (p) => <Icon {...p}>ï¼‹</Icon>, minus: (p) => <Icon {...p}>âˆ’</Icon>, up: (p) => <Icon {...p}>ğŸ“ˆ</Icon>, warn: (p) => <Icon {...p}>âš ï¸</Icon>,
            cal: (p) => <Icon {...p}>ğŸ“…</Icon>, chevR: (p) => <Icon {...p}>â€º</Icon>, chart: (p) => <Icon {...p}>ğŸ“Š</Icon>, info: (p) => <Icon {...p}>â„¹ï¸</Icon>,
            spark: (p) => <Icon {...p}>âœ¨</Icon>, beaker: (p) => <Icon {...p}>ğŸ§ª</Icon>, bag: (p) => <Icon {...p}>ğŸ›ï¸</Icon>, bulb: (p) => <Icon {...p}>ğŸ’¡</Icon>, close: (p) => <Icon {...p}>âœ•</Icon>,
            trash: (p) => <Icon {...p}>ğŸ—‘ï¸</Icon>, user: (p) => <Icon {...p}>ğŸ‘¤</Icon>, key: (p) => <Icon {...p}>ğŸ”‘</Icon>, logout: (p) => <Icon {...p}>ğŸšª</Icon>,
        };

        const BIOMARKER_DETAILS = {
            PINK1: { fullName: 'PINK1 (PTEN-induced kinase 1)', function: 'ë¯¸í† ì½˜ë“œë¦¬ì•„ í’ˆì§ˆ ê´€ë¦¬ ë° ì„¸í¬ ì—ë„ˆì§€ ëŒ€ì‚¬.', mechanism: 'ë§ˆì´í† íŒŒì§€ ì¡°ì ˆ.', ingredients: [{ name: 'ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ', description: 'ë¯¸í† ì½˜ë“œë¦¬ì•„ ê¸°ëŠ¥ í–¥ìƒ', concentration: '2-5%' }, { name: 'ë ˆí‹°ë†€', description: 'ì„¸í¬ ì¬ìƒ ì´‰ì§„', concentration: '0.25-1%' }], products: ['ë” ì˜¤ë””ë„ˆë¦¬ ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ 10%', 'ë¡œë ˆì•Œ ë ˆë¹„íƒˆë¦¬í”„íŠ¸ ë‚˜ì´íŠ¸ ì„¸ëŸ¼'], tips: ['ì¶©ë¶„í•œ ìˆ˜ë©´', 'í•­ì‚°í™” ì‹í’ˆ ì„­ì·¨'] },
            COL1A1: { fullName: 'COL1A1', function: 'ì½œë¼ê² í•©ì„±', mechanism: 'ì œ1í˜• ì½œë¼ê² Î±1 ì‚¬ìŠ¬ ì•”í˜¸í™”.', ingredients: [{ name: 'ë¹„íƒ€ë¯¼ C', description: 'ì½œë¼ê² í•©ì„± ì´‰ì§„', concentration: '10-20%' }], products: ['CEí˜ë¦° ë¹„íƒ€ë¯¼C ì„¸ëŸ¼'], tips: ['ë¹„íƒ€ë¯¼ C ìŒì‹ ì„­ì·¨'] },
            MSN: { fullName: 'MSN (Moesin)', function: 'ì„¸í¬ë§‰ ì•ˆì •ì„±', mechanism: 'ì„¸í¬ê³¨ê²© ì—°ê²°', ingredients: [{ name: 'ì„¸ë¼ë§ˆì´ë“œ', description: 'ì„¸í¬ë§‰ ê°•í™”', concentration: '2-5%' }], products: ['CeraVe ëª¨ì´ìŠ¤ì²˜ë¼ì´ì§• í¬ë¦¼'], tips: ['ê³¼ë„í•œ ì„¸ì•ˆ í”¼í•˜ê¸°'] },
            HAS2: { fullName: 'HAS2', function: 'íˆì•Œë£¨ë¡ ì‚° í•©ì„±', mechanism: 'í”¼ë¶€ ìˆ˜ë¶„ ê³µê¸‰', ingredients: [{ name: 'íˆì•Œë£¨ë¡ ì‚°', description: 'ìˆ˜ë¶„ ê³µê¸‰', concentration: '0.5-2%' }], products: ['ë” ì˜¤ë””ë„ˆë¦¬ íˆì•Œë£¨ë¡ ì‚° 2% + B5'], tips: ['ì¶©ë¶„í•œ ë¬¼ ì„­ì·¨'] },
            FLG: { fullName: 'FLG', function: 'ê°ì§ˆì¸µ ë³´ìŠµ ì¸ì', mechanism: 'ì²œì—°ë³´ìŠµì¸ì ìƒì„±', ingredients: [{ name: 'ìš°ë ˆì•„', description: 'ë³´ìŠµì¸ì ë³´ì¶©', concentration: '5-10%' }], products: ['ìœ ì„¸ë¦° UreaRepair í¬ë¦¼'], tips: ['ì§§ì€ ìƒ¤ì›Œ'] },
            AQP3: { fullName: 'AQP3', function: 'ìˆ˜ë¶„ í†µë¡œ', mechanism: 'ë¬¼ ë¶„ì ì´ë™', ingredients: [{ name: 'ê¸€ë¦¬ì„¸ë¦°', description: 'ìˆ˜ë¶„ ì „ë‹¬ ì´‰ì§„', concentration: '5-15%' }], products: ['ë‰´íŠ¸ë¡œì§€ë‚˜ í•˜ì´ë“œë¼ë¶€ìŠ¤íŠ¸ ì„¸ëŸ¼'], tips: ['í•˜ë£¨ 2-3L ìˆ˜ë¶„'] },
            SPINK5: { fullName: 'SPINK5', function: 'ì¥ë²½ ë³´í˜¸', mechanism: 'ì„¸ë¦° í”„ë¡œí…Œì•„ì œ ì–µì œ', ingredients: [{ name: 'ì•Œë€í† ì¸', description: 'ì§„ì •', concentration: '0.5-2%' }], products: ['ë¼ë¡œìŠˆí¬ì œ í†¨ë ˆë¦¬ì•ˆ ì¼€ì–´'], tips: ['ìê·¹ ì„±ë¶„ í”¼í•˜ê¸°'] },
            MLANA: { fullName: 'MLANA', function: 'ë©œë¼ë‹Œ ìƒì„±', mechanism: 'ë©œë¼ë…¸ì‚¬ì´íŠ¸ ì„±ìˆ™', ingredients: [{ name: 'ë¹„íƒ€ë¯¼ C', description: 'ë©œë¼ë‹Œ ì–µì œ', concentration: '10-20%' }], products: ['í´ë¦¬ë‹ˆí¬ ì´ë¸ ë² í„° ì„¸ëŸ¼'], tips: ['ë§¤ì¼ ìì°¨'] },
            TFAP2A: { fullName: 'TFAP2A', function: 'ìƒ‰ì†Œ ì „ì‚¬ ì¸ì', mechanism: 'ë©œë¼ë…¸ì‚¬ì´íŠ¸ ë¶„í™”', ingredients: [{ name: 'ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ', description: 'ë©œë¼ë‹Œ ì „ë‹¬ ì–µì œ', concentration: '5-10%' }], products: ['ë” ì˜¤ë””ë„ˆë¦¬ ì•ŒíŒŒ ì•„ë¥´ë¶€í‹´ 2%'], tips: ['ê¾¸ì¤€í•œ ìì°¨'] },
            SOD1: { fullName: 'SOD1', function: 'í•­ì‚°í™”', mechanism: 'í™œì„±ì‚°ì†Œ ì œê±°', ingredients: [{ name: 'ë¹„íƒ€ë¯¼ E', description: 'í•­ì‚°í™” ì‹œë„ˆì§€', concentration: '0.5-1%' }], products: ['SkinCeuticals CE Ferulic'], tips: ['í•­ì‚°í™” ìŒì‹'] },
            VDR: { fullName: 'VDR', function: 'ë¹„íƒ€ë¯¼ D ìˆ˜ìš©ì²´', mechanism: 'ì„¸í¬ ê¸°ëŠ¥ ì¡°ì ˆ', ingredients: [{ name: 'ë¹„íƒ€ë¯¼ D3', description: 'VDR í™œì„±í™”', concentration: '1000-4000IU' }], products: ['ë„¤ì´ì²˜ë©”ì´ë“œ ë¹„íƒ€ë¯¼ D3'], tips: ['ì ë‹¹í•œ ì¼ê´‘ìš•'] },
        };

        const GENE_ORDER = ['PINK1', 'COL1A1', 'MSN', 'HAS2', 'FLG', 'AQP3', 'SPINK5', 'MLANA', 'TFAP2A', 'SOD1', 'VDR'];


        // ê¶Œì¥ ì„±ë¶„ â†’ ê²€ìƒ‰ í‚¤ì›Œë“œ ë§¤í•‘ (í•„ìš” ì‹œ ììœ ë¡­ê²Œ ë³´ê°•)
        const INGREDIENT_QUERY_MAP = {
            'ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ': 'ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ ì„¸ëŸ¼',
            'ë ˆí‹°ë†€': 'ë ˆí‹°ë†€ ì„¸ëŸ¼',
            'ë¹„íƒ€ë¯¼ C': 'ë¹„íƒ€ë¯¼C ì„¸ëŸ¼',
            'ì„¸ë¼ë§ˆì´ë“œ': 'ì„¸ë¼ë§ˆì´ë“œ í¬ë¦¼',
            'íˆì•Œë£¨ë¡ ì‚°': 'íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼',
            'ìš°ë ˆì•„': 'ìš°ë ˆì•„ í¬ë¦¼',
            'ê¸€ë¦¬ì„¸ë¦°': 'ê¸€ë¦¬ì„¸ë¦° í¬ë¦¼',
            'ì•Œë€í† ì¸': 'ì•Œë€í† ì¸ í¬ë¦¼',
            'ë¹„íƒ€ë¯¼ E': 'ë¹„íƒ€ë¯¼E ì„¸ëŸ¼',
            'ë¹„íƒ€ë¯¼ D3': 'ë¹„íƒ€ë¯¼D3 ë³´ì¶©ì œ'
        };

        // Z-score â†’ ì‹¬ê°ë„ ë¶„ë¥˜
        function classifySeverity(value, mean, sd) {
            if (sd === 0 || sd == null) return { z: 0, level: 'maintain' };
            const z = Math.abs((value - mean) / sd);
            if (z > 2) return { z, level: 'urgent' };      // ê¸´ê¸‰ ê°œì„ 
            if (z > 1) return { z, level: 'caution' };     // ì£¼ì˜ ê´€ì°°
            return { z, level: 'maintain' };               // í˜„ì¬ ìƒíƒœ ìœ ì§€
        }

        // currentData â†’ í‰íƒ„í™” ë¦¬ìŠ¤íŠ¸
        function flattenMarkers(current) {
            const list = [];
            if (!current?.biomarkers) return list;
            for (const cat of ['aging', 'dryness', 'pigmentation']) {
                for (const m of (current.biomarkers[cat] || [])) {
                    list.push({
                        category: cat,
                        gene: m.gene,
                        name: m.name,
                        value: Number(m.value),
                        mean: Number(m.koreanMean),
                        sd: Number(m.stdDev),
                    });
                }
            }
            return list;
        }

        // ì¶”ì²œ ìƒì„± (BIOMARKER_DETAILS í™œìš©)
        function buildRecommendations(current) {
            const items = flattenMarkers(current).map(m => {
                const cls = classifySeverity(m.value, m.mean, m.sd);
                const info = (typeof BIOMARKER_DETAILS !== 'undefined') ? BIOMARKER_DETAILS[m.gene] || {} : {};
                return {
                    ...m,
                    z: cls.z,
                    level: cls.level,
                    fullName: info.fullName || m.gene,
                    ingredients: info.ingredients || [],
                    tips: info.tips || [],
                };
            });

            return {
                urgent: items.filter(i => i.level === 'urgent').sort((a, b) => b.z - a.z),
                caution: items.filter(i => i.level === 'caution').sort((a, b) => b.z - a.z),
                maintain: items.filter(i => i.level === 'maintain').sort((a, b) => a.gene.localeCompare(b.gene)),
            };
        }

        // ì„œë²„(Apps Script) ê²½ìœ ë¡œ ë„¤ì´ë²„ ì‡¼í•‘ ê²€ìƒ‰
        async function apiSearchProducts(query, display = 6) {
            const payload = { token: SHEETS_TOKEN, action: 'searchProducts', query, display };
            const res = await fetch(SHEETS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.ok) {
                const err = String(data.error || 'search_failed');
                // â— ì£¼ìš” ì—ëŸ¬ë“¤ ê°€ë…ì„± ë†’ì´ê¸°
                if (err === 'missing_credentials') {
                    throw new Error('ë„¤ì´ë²„ API ìê²©ì¦ëª…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                }
                if (err.startsWith('upstream_error_')) {
                    throw new Error('ë„¤ì´ë²„ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                if (err === 'missing_query') {
                    throw new Error('ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
                }
                if (err === 'unauthorized') {
                    throw new Error('ì¸ì¦ í† í°ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                throw new Error(err);
            }
            return data.items || [];
        }
        function RecommendationsView({ onBack, current }) {
            // ì•ˆì „ ê°€ë“œ
            const safeCurrent = current || { biomarkers: { aging: [], dryness: [], pigmentation: [] } };

            // â‘  Z-score ê¸°ë°˜ ê°œì¸í™” ì¶”ì²œ(ê¸´ê¸‰/ì£¼ì˜/ìœ ì§€)
            const rec = React.useMemo(() => buildRecommendations(safeCurrent), [safeCurrent]);

            // â‘¡ ì„±ë¶„ â†’ ì‹¤ì‹œê°„ ìƒí’ˆ ê²€ìƒ‰ ìƒíƒœ
            const [selectedIngredient, setSelectedIngredient] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [products, setProducts] = React.useState([]);

            async function handleSearch(ingredientName) {
                const q = INGREDIENT_QUERY_MAP[ingredientName] || ingredientName;
                try {
                    setLoading(true);
                    setProducts([]);
                    const items = await apiSearchProducts(q, 8);
                    setProducts(items);
                } catch (e) {
                    alert(e.message || 'ìƒí’ˆ ì¶”ì²œì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    setLoading(false);
                }
            }

            // í˜„ì¬ ì¶”ì²œ ëª©ë¡ì—ì„œ â€œê¶Œì¥ ì„±ë¶„â€ë§Œ í‰íƒ„í™”í•´ í•œ ë²ˆì— ì„ íƒí•  ìˆ˜ ìˆëŠ” í•„í„° ë²„íŠ¼(UI)
            const allIng = React.useMemo(() => {
                const result = [];
                [...rec.urgent, ...rec.caution, ...rec.maintain].forEach(x => {
                    (x.ingredients || []).forEach(i => result.push(i.name));
                });
                return Array.from(new Set(result));
            }, [rec]);

            function Section({ title, color, items, emptyText }) {
                return (
                    <Card className="p-6">
                        <h4 className={`font-bold mb-4 ${color.title}`}>{title}</h4>
                        {items.length === 0 ? (
                            <p className="text-sm text-slate-500">{emptyText}</p>
                        ) : (
                            <div className="space-y-4">
                                {items.map((it, idx) => (
                                    <div key={it.gene + idx} className={`p-4 rounded-xl border ${color.box}`}>
                                        <div className="flex items-center justify-between mb-1">
                                            <div className="font-semibold text-slate-900">
                                                {it.gene}
                                                <span className="ml-2 text-slate-500 text-sm">{it.fullName}</span>
                                            </div>
                                            <div className="text-xs text-slate-500">
                                                Z: {it.z.toFixed(2)} Â· Î”Ct: {it.value} (í‰ê·  {it.mean})
                                            </div>
                                        </div>
                                        <div className="text-sm text-slate-700 mb-2">{it.name}</div>

                                        {/* ê¶Œì¥ ì„±ë¶„ pill (í´ë¦­ ì‹œ ìƒí’ˆ ê²€ìƒ‰) */}
                                        {it.ingredients.length > 0 && (
                                            <div className="text-sm">
                                                <div className="font-medium mb-2">ê¶Œì¥ ì„±ë¶„</div>
                                                <div className="flex flex-wrap gap-2">
                                                    {it.ingredients.map((ing, i) => (
                                                        <button
                                                            key={i}
                                                            onClick={() => { setSelectedIngredient(ing.name); handleSearch(ing.name); }}
                                                            className={`px-2.5 py-1 rounded-full border text-xs ${selectedIngredient === ing.name ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50'}`}
                                                            title={ing.description + (ing.concentration ? ` (${ing.concentration})` : '')}
                                                        >
                                                            {ing.name}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </Card>
                );
            }

            // ìƒí’ˆ ì¶”ì²œ ê·¸ë¦¬ë“œ
            function ProductGrid() {
                if (!selectedIngredient) {
                    return <p className="text-sm text-slate-500">ìœ„ì˜ ê¶Œì¥ ì„±ë¶„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ì²œ ìƒí’ˆì„ ì¡°íšŒí•˜ì„¸ìš”.</p>;
                }
                if (loading) return <p className="text-sm text-slate-500">ì¶”ì²œ ìƒí’ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>;
                if (products.length === 0) return <p className="text-sm text-slate-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>;
                return (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {products.map((p, idx) => (
                            <a key={idx} href={p.link} target="_blank" rel="noopener noreferrer" className="p-4 rounded-xl border bg-white hover:shadow-md transition">
                                <div className="flex gap-3">
                                    {p.image && <img src={p.image} alt="" className="w-20 h-20 object-cover rounded-lg border" />}
                                    <div className="flex-1">
                                        {/* ë„¤ì´ë²„ ì‘ë‹µ titleì— HTML íƒœê·¸ê°€ ì„ì—¬ìˆì–´ì„œ dangerouslySetInnerHTML ì‚¬ìš© */}
                                        <div className="text-sm font-semibold text-slate-900" dangerouslySetInnerHTML={{ __html: p.title }} />
                                        <div className="text-xs text-slate-500 mt-1">{p.brand || p.mallName || 'ì•Œìˆ˜ì—†ìŒ'}</div>
                                        {p.lprice && <div className="text-sm font-bold text-indigo-600 mt-1">{Number(p.lprice).toLocaleString()}ì› ~</div>}
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
                    <div className="max-w-4xl mx-auto p-4">
                        <Card className="p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <button onClick={onBack} className="flex items-center gap-2 text-slate-600">
                                    <span className="rotate-180">â€º</span><span>ë’¤ë¡œ</span>
                                </button>
                                <h1 className="text-xl font-bold text-slate-900">ğŸ’¡ ë§ì¶¤ ì¶”ì²œ</h1>
                            </div>
                        </Card>

                        {/* ê°œì¸í™” ì¶”ì²œ 3ë‹¨ê³„ */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Section title="ğŸš¨ ê¸´ê¸‰ ê°œì„ " color={{ title: 'text-rose-800', box: 'border-rose-200 bg-rose-50' }}
                                items={rec.urgent} emptyText="ê¸´ê¸‰ ê°œì„ ì´ í•„ìš”í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤." />
                            <Section title="âš ï¸ ì£¼ì˜ ê´€ì°°" color={{ title: 'text-amber-800', box: 'border-amber-200 bg-amber-50' }}
                                items={rec.caution} emptyText="ì£¼ì˜ ê´€ì°°ì´ í•„ìš”í•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤." />
                            <Section title="âœ… í˜„ì¬ ìƒíƒœ ìœ ì§€" color={{ title: 'text-emerald-800', box: 'border-emerald-200 bg-emerald-50' }}
                                items={rec.maintain} emptyText="ìœ ì§€ì— í•´ë‹¹í•˜ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤." />
                        </div>

                        {/* ì„±ë¶„ ì „ì²´ì—ì„œ í•œ ë²ˆì— ê³ ë¥¼ ìˆ˜ ìˆëŠ” í•„í„°(ì„ íƒì€ ì•„ë˜ ProductGridì™€ ê³µìœ ) */}
                        {allIng.length > 0 && (
                            <Card className="p-6 mt-6">
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-bold text-slate-900">ğŸ›ï¸ ì„±ë¶„ë³„ ì¶”ì²œ ìƒí’ˆ(ì‹¤ì‹œê°„)</h4>
                                    {selectedIngredient && <span className="text-sm text-slate-600">ì„ íƒ ì„±ë¶„: <b>{selectedIngredient}</b></span>}
                                </div>
                                <div className="flex flex-wrap gap-2 mb-4">
                                    {allIng.map(name => (
                                        <button key={name}
                                            onClick={() => { setSelectedIngredient(name); handleSearch(name); }}
                                            className={`px-3 py-1.5 rounded-full text-sm border ${selectedIngredient === name ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white hover:bg-slate-50 border-slate-200 text-slate-700'}`}>
                                            {name}
                                        </button>
                                    ))}
                                </div>
                                <ProductGrid />
                            </Card>
                        )}
                    </div>
                </div>
            );
        }

        /* ---------- API ë˜í¼ ---------- */
        async function apiGetReports(userId) {
            const url = userId ? `${SHEETS_API_URL}?userId=${encodeURIComponent(userId)}` : SHEETS_API_URL;
            const res = await fetch(url, { method: 'GET' });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'GET failed');
            const items = (data.items || []).map(r => {
                const base = {
                    id: String(r.id || ''), date: String(r.date || ''), week: Number(r.week || 0),
                    title: String(r.title || ''), overallScore: Number(r.overallScore || 0),
                    status: String(r.status || 'completed'), userId: String(r.userId || '')
                };
                const genes = {};
                GENE_ORDER.forEach(g => { genes[g] = (r[g] === undefined || r[g] === '') ? null : Number(r[g]); });
                return { ...base, genes };
            });
            items.sort((a, b) => b.date.localeCompare(a.date));
            return items;
        }

        async function apiCreateReport(newReport) {
            const payload = { token: SHEETS_TOKEN, action: 'create', ...newReport };
            const res = await fetch(SHEETS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'POST failed');
            return true;
        }

        async function apiDeleteReport(id, userId) {
            const payload = { token: SHEETS_TOKEN, action: 'delete', id, userId };
            const res = await fetch(SHEETS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'DELETE failed');
            return true;
        }

        async function apiSignup({ email, name, password }) {
            const res = await fetch(SHEETS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ token: SHEETS_TOKEN, action: 'signup', email, name, password })
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'SIGNUP failed');
            return data.user;
        }

        async function apiLogin({ email, password }) {
            const res = await fetch(SHEETS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ token: SHEETS_TOKEN, action: 'login', email, password })
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'LOGIN failed');
            return data.user;
        }

        /* ---------- ì ìˆ˜ ê³„ì‚°(ê¸°ì¡´ ìœ ì§€) ---------- */
        function calcOverallScoreFromSample(data) {
            const all = [...data.biomarkers.aging, ...data.biomarkers.dryness, ...data.biomarkers.pigmentation];
            const toLevel = (m) => Math.max(0, Math.min(100, (100 - m.value) / 2));
            return Math.round(all.reduce((s, m) => s + toLevel(m), 0) / all.length);
        }

        /* ---------- ê³µí†µ UI ---------- */
        function Card({ children, className = '', ...props }) {
            const clickable = typeof props.onClick === 'function';
            const base = 'bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg border border-white/50 ';
            return (
                <div
                    {...props}
                    className={base + className}
                    role={clickable ? 'button' : props.role}
                    tabIndex={clickable ? 0 : props.tabIndex}
                    onKeyDown={clickable ? (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); props.onClick?.(e); } } : props.onKeyDown}
                >{children}</div>
            );
        }

        /* ---------- ì¹´ë“œ/ëª¨ë‹¬(ê¸°ì¡´ ìœ ì§€) ---------- */
        function BiomarkerCard({ marker, onSelectGene }) {
            const z = Math.abs((marker.value - marker.koreanMean) / marker.stdDev);
            const status = z <= 1 ? 'normal' : z <= 2 ? 'warning' : 'critical';
            const icon = status === 'normal' ? <I.minus className="w-4 h-4 text-emerald-500" /> : status === 'warning' ? <I.up className="w-4 h-4 text-amber-500" /> : <I.warn className="w-4 h-4 text-rose-500" />;
            const color = status === 'normal' ? 'border-emerald-200 from-emerald-50 to-cyan-50' : status === 'warning' ? 'border-amber-200 from-amber-50 to-orange-50' : 'border-rose-200 from-rose-50 to-pink-50';
            const expressionLevel = Math.max(0, Math.min(100, (100 - marker.value) / 2));
            return (
                <div className={`p-4 rounded-2xl border-2 bg-gradient-to-br ${color} transition-all duration-300 cursor-pointer hover:shadow-lg hover:scale-[1.02]`} onClick={() => onSelectGene?.(marker.gene)}>
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">{icon}<span className="font-bold text-slate-800 text-sm tracking-wide">{marker.gene}</span></div>
                        <span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full font-medium">Î”Ct</span>
                    </div>
                    <div className="mb-3"><span className="text-xl font-bold text-slate-900">{marker.value}</span><span className="text-xs text-slate-500 ml-2">(í‰ê· : {marker.koreanMean})</span></div>
                    <div className="text-xs text-slate-600 mb-3 font-medium">{marker.name}</div>
                    <div className="w-full bg-slate-200 rounded-full h-2.5"><div className="h-2.5 rounded-full transition-all duration-1000" style={{ width: `${expressionLevel}%`, background: 'linear-gradient(90deg,#6366f1,#a855f7)' }} /></div>
                    <div className="text-xs text-slate-500 mt-2 text-center font-medium">ë°œí˜„ ë ˆë²¨: {Math.round(expressionLevel)}%</div>
                </div>
            );
        }

        function GeneDetailModal({ gene, onClose }) {
            const info = BIOMARKER_DETAILS[gene] || {};
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white flex items-center justify-between">
                            <h3 className="font-bold">{gene} ìƒì„¸</h3>
                            <button className="px-3 py-1.5 bg-white/20 rounded-lg" onClick={onClose}><I.close /></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <div className="text-slate-900 font-bold mb-1">{info.fullName || gene}</div>
                                <div className="text-slate-700 text-sm">{info.function}</div>
                                <div className="text-slate-500 text-sm">{info.mechanism}</div>
                            </div>
                            {info.ingredients && (
                                <div className="p-4 rounded-xl bg-indigo-50 border border-indigo-200">
                                    <div className="font-semibold text-indigo-800 mb-2">ê¶Œì¥ ì„±ë¶„</div>
                                    <ul className="text-sm text-indigo-900 list-disc pl-5 space-y-1">
                                        {info.ingredients.map((it, i) => (<li key={i}>{it.name} â€” {it.description} ({it.concentration})</li>))}
                                    </ul>
                                </div>
                            )}
                            {info.tips && (
                                <div className="p-4 rounded-xl bg-emerald-50 border border-emerald-200">
                                    <div className="font-semibold text-emerald-800 mb-2">ê´€ë¦¬ íŒ</div>
                                    <ul className="text-sm text-emerald-900 list-disc pl-5 space-y-1">
                                        {info.tips.map((t, i) => (<li key={i}>{t}</li>))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        /* ---------- ìƒ˜í”Œ ì…ë ¥ í…œí”Œë¦¿ ---------- */
        const SAMPLE_CURRENT_DATA = {
            userId: '', analysisId: 'analysis456', timestamp: new Date(), week: 0,
            biomarkers: {
                aging: [{ gene: 'PINK1', value: -15, koreanMean: -10, stdDev: 8, name: 'ë¯¸í† ì½˜ë“œë¦¬ì•„ ê¸°ëŠ¥' }, { gene: 'COL1A1', value: 25, koreanMean: 15, stdDev: 12, name: 'ì½œë¼ê² ìƒì„±' }, { gene: 'MSN', value: -5, koreanMean: 0, stdDev: 6, name: 'ì„¸í¬ë§‰ ì•ˆì •ì„±' }, { gene: 'HAS2', value: 30, koreanMean: 20, stdDev: 10, name: 'íˆì•Œë£¨ë¡ ì‚° í•©ì„±' }],
                dryness: [{ gene: 'FLG', value: 40, koreanMean: 25, stdDev: 15, name: 'í•„ë¼ê·¸ë¦°' }, { gene: 'AQP3', value: -20, koreanMean: -15, stdDev: 8, name: 'ì•„ì¿ ì•„í¬ë¦°-3' }, { gene: 'SPINK5', value: 10, koreanMean: 5, stdDev: 7, name: 'ì„¸ë¦° í”„ë¡œí…Œì•„ì œ ì–µì œ' }],
                pigmentation: [{ gene: 'MLANA', value: -25, koreanMean: -20, stdDev: 9, name: 'ë©œë¼ë‹Œ ìƒì„±' }, { gene: 'TFAP2A', value: 15, koreanMean: 10, stdDev: 8, name: 'ì „ì‚¬ì¸ì AP-2Î±' }, { gene: 'SOD1', value: -10, koreanMean: -5, stdDev: 6, name: 'í•­ì‚°í™” íš¨ì†Œ' }, { gene: 'VDR', value: 35, koreanMean: 20, stdDev: 12, name: 'ë¹„íƒ€ë¯¼D ìˆ˜ìš©ì²´' }],
            }
        };

        function buildDataFromReport(report) {
            const clone = JSON.parse(JSON.stringify(SAMPLE_CURRENT_DATA));
            const lookup = (g) => (report?.genes?.[g] ?? null);
            const apply = (arr) => arr.map(m => ({ ...m, value: Number(lookup(m.gene) ?? m.value) }));
            clone.biomarkers.aging = apply(clone.biomarkers.aging);
            clone.biomarkers.dryness = apply(clone.biomarkers.dryness);
            clone.biomarkers.pigmentation = apply(clone.biomarkers.pigmentation);
            return clone;
        }

        /* ---------- ì…ë ¥ ëª¨ë‹¬(ê¸°ì¡´ ìœ ì§€ + ì œëª© í•„ë“œ ì¶”ê°€ ê°€ëŠ¥ ì‹œ í™•ì¥) ---------- */
        function NewAnalysisModal({ initialData, onCancel, onConfirm, saving }) {
            function makeBlank(d) {
                const next = JSON.parse(JSON.stringify(d));
                ['aging', 'dryness', 'pigmentation'].forEach(cat => {
                    next.biomarkers[cat] = next.biomarkers[cat].map(m => ({ ...m, value: '' }));
                });
                next.title = '';
                return next;
            }
            const [draft, setDraft] = React.useState(() => makeBlank(initialData));
            function setVal(cat, gene, value) {
                setDraft(prev => {
                    const next = JSON.parse(JSON.stringify(prev));
                    const arr = next.biomarkers[cat];
                    const i = arr.findIndex(m => m.gene === gene);
                    if (i >= 0) arr[i].value = value;
                    return next;
                });
            }
            function handleSave() {
                const cloned = JSON.parse(JSON.stringify(draft));
                if (!String(cloned.title || '').trim()) { alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                for (const cat of ['aging', 'dryness', 'pigmentation']) {
                    for (const m of cloned.biomarkers[cat]) {
                        const v = String(m.value).trim();
                        if (v === '' || isNaN(Number(v))) { alert(`${m.gene} ê°’ì— ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.`); return; }
                        m.value = Number(v);
                    }
                }
                onConfirm(cloned);
            }

            const cats = [['aging', 'í”¼ë¶€ ë…¸í™”'], ['dryness', 'í”¼ë¶€ ê±´ì¡°'], ['pigmentation', 'í”¼ë¶€ ìƒ‰ì†Œ']];

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto shadow-2xl">
                        <div className="sticky top-0 p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-t-2xl">
                            <div className="flex items-center justify-between">
                                <h2 className="text-lg font-bold">ìƒˆ ë¶„ì„ ê°’ ì…ë ¥</h2>
                                <div className="flex gap-2">
                                    <button onClick={onCancel} className="px-3 py-1.5 bg-white/20 rounded-lg" disabled={saving}>ì·¨ì†Œ</button>
                                    <button onClick={handleSave} className="px-3 py-1.5 bg-white text-indigo-700 rounded-lg font-semibold disabled:opacity-60" disabled={saving}>{saving ? 'ì €ì¥ ì¤‘ì…ë‹ˆë‹¤â€¦' : 'ì €ì¥'}</button>
                                </div>
                            </div>
                        </div>

                        <div className="p-6 space-y-8">
                            <div className="p-4 rounded-xl border bg-slate-50">
                                <label className="text-sm text-slate-600">ì œëª©</label>
                                <input type="text" className="mt-1 w-full border rounded-lg px-3 py-2 bg-white" placeholder="ì˜ˆ) 1ì£¼ì°¨ ë² ì´ìŠ¤ë¼ì¸" value={draft.title} onChange={e => setDraft(prev => ({ ...prev, title: e.target.value }))} />
                            </div>

                            {cats.map(([key, label]) => (
                                <div key={key}>
                                    <h3 className="font-bold text-slate-900 mb-3">{label}</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {draft.biomarkers[key].map(m => (
                                            <div key={m.gene} className="p-4 rounded-xl border bg-slate-50">
                                                <div className="font-semibold text-slate-800 mb-2">{m.gene} <span className="text-slate-500 text-sm ml-1">{m.name}</span></div>
                                                <label className="text-sm text-slate-600">Î”Ct ê°’</label>
                                                <input type="number" step="1" className="mt-1 w-full border rounded-lg px-3 py-2 bg-white" placeholder="ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”" value={m.value} onChange={e => setVal(key, m.gene, e.target.value)} />
                                                <div className="text-xs text-slate-500 mt-2">í•œêµ­ì¸ í‰ê·  {m.koreanMean}, í‘œì¤€í¸ì°¨ {m.stdDev}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        /* ---------- ë·°ë“¤(ê¸°ì¡´ ìœ ì§€) ---------- */
        function ReportsListView({ reports, onOpenReport, onOpenComparison, onCreateNew, loading, user, onLogout }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
                    <div className="max-w-4xl mx-auto p-4">
                        <Card className="p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-900 tracking-tight">ğŸ§¬ í”¼ë¶€ ìœ ì „ì ë¶„ì„</h1>
                                    <p className="text-slate-600 mt-1">ë‚˜ì˜ ë¶„ì„ ê¸°ë¡</p>
                                </div>
                                <div className="flex items-center gap-3">
                                    <div className="px-3 py-2 bg-slate-100 rounded-xl text-sm text-slate-700 flex items-center gap-2"><I.user /> <span className="font-medium">{user?.name || user?.email}</span></div>
                                    <button className="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm flex items-center gap-1" onClick={onLogout}><I.logout /> ë¡œê·¸ì•„ì›ƒ</button>
                                    <button className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 hover:shadow-lg disabled:opacity-50" onClick={onCreateNew} disabled={loading}><I.plus /> <span>{loading ? 'ì €ì¥ ì¤‘â€¦' : 'ìƒˆ ë¶„ì„'}</span></button>
                                </div>
                            </div>
                        </Card>

                        {reports.length === 0 ? (
                            <Card className="p-6 text-center text-slate-600">
                                {loading ? 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦' : 'ì•„ì§ ì €ì¥ëœ ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤.'}
                            </Card>
                        ) : (
                            <div className="space-y-4">
                                {reports.map(r => (
                                    <Card key={r.id} className="p-6 cursor-pointer hover:shadow-xl transition hover:scale-[1.01]" onClick={() => onOpenReport(r)}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-4">
                                                <div className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center"><span className="text-white font-bold text-sm">{r.week}ì£¼</span></div>
                                                <div>
                                                    <h3 className="font-bold text-slate-900 text-lg">{r.title || 'ì œëª© ì—†ìŒ'}</h3>
                                                    <p className="text-slate-600 flex items-center mt-1"><I.cal className="mr-1" /> {r.date ? new Date(r.date).toLocaleDateString('ko-KR') : '-'}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <div className="text-right">
                                                    <div className="text-2xl font-bold text-indigo-600">{r.overallScore}</div>
                                                    <div className="text-xs text-slate-500 font-medium">ì¢…í•©ì ìˆ˜</div>
                                                </div>
                                                <I.chevR className="text-slate-400" />
                                            </div>
                                        </div>
                                    </Card>
                                ))}
                            </div>
                        )}

                        <div className="mt-8">
                            <Card className="p-6 text-center cursor-pointer hover:shadow-xl" onClick={onOpenComparison}>
                                <div className="flex items-center justify-center gap-2"><I.chart className="text-indigo-600" /> <span className="font-semibold text-slate-800 text-lg">ì „ì²´ íˆìŠ¤í† ë¦¬ ì°¨íŠ¸ ë³´ê¸°</span></div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        }

        function AnalysisResultView({ data, report, onBack, onOpenComparison, onOpenRecommendations, onOpenRoutine, onSelectGene, onDelete }) {
            const overallScore = report?.overallScore ?? 78;
            const CategorySection = ({ title, markers, icon }) => (
                <div className="mb-8">
                    <div className="flex items-center gap-3 mb-4"><span className="text-2xl">{icon}</span><h3 className="text-xl font-bold text-slate-900 tracking-tight">{title}</h3></div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">{markers.map(m => (<BiomarkerCard key={m.gene} marker={m} onSelectGene={onSelectGene} />))}</div>
                </div>
            );
            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
                    <div className="max-w-4xl mx-auto p-4">
                        <Card className="p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <button onClick={onBack} className="flex items-center gap-2 text-slate-600 hover:text-slate-800"><span className="rotate-180"><I.chevR /></span><span className="font-medium">ë¦¬í¬íŠ¸ ëª©ë¡</span></button>
                                <div className="flex items-center gap-2">
                                    <button onClick={onDelete} className="px-3 py-2 rounded-lg bg-rose-100 text-rose-700 hover:bg-rose-200 flex items-center gap-1"><I.trash /> ì‚­ì œ</button>
                                    <div className="text-right">
                                        <h1 className="text-xl font-bold text-slate-900">{report?.title || 'ë¶„ì„ ê²°ê³¼'}</h1>
                                        <p className="text-slate-600 text-sm">{report?.date ? new Date(report.date).toLocaleDateString('ko-KR') : ''}</p>
                                    </div>
                                </div>
                            </div>
                        </Card>

                        <div className="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 rounded-2xl p-8 mb-8 text-white shadow-2xl">
                            <div className="text-center">
                                <div className="text-6xl font-bold text-white mb-4 tracking-tight">{overallScore}</div>
                                <div className="text-xl opacity-90 mb-2 font-medium">ì¢…í•© ìœ ì „ì ì ìˆ˜</div>
                                <div className="text-sm text-indigo-100">11ê°œ ë°”ì´ì˜¤ë§ˆì»¤ ê¸°ì¤€</div>
                                <div className="w-full bg-white/20 rounded-full h-4 mt-6"><div className="bg-gradient-to-r from-yellow-400 to-orange-400 h-4 rounded-full transition-all duration-1000" style={{ width: `${overallScore}%` }} /></div>
                            </div>
                        </div>

                        <div className="space-y-8">
                            <CategorySection title="í”¼ë¶€ ë…¸í™”" markers={data.biomarkers.aging} icon="â³" />
                            <CategorySection title="í”¼ë¶€ ê±´ì¡°" markers={data.biomarkers.dryness} icon="ğŸ’§" />
                            <CategorySection title="í”¼ë¶€ ìƒ‰ì†Œ" markers={data.biomarkers.pigmentation} icon="ğŸ¨" />
                        </div>

                        <div className="grid grid-cols-2 gap-4 mt-8">
                            <Card className="p-6 text-center cursor-pointer hover:shadow-xl" onClick={onOpenComparison}>
                                <div className="flex items-center justify-center gap-2"><I.chart className="text-indigo-600" /> <span className="font-semibold text-slate-800">ë¹„êµ ì°¨íŠ¸</span></div>
                            </Card>
                            <Card className="p-6 text-center cursor-pointer bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:shadow-xl" onClick={onOpenRecommendations}>
                                <div className="flex items-center justify-center gap-2"><I.info /> <span className="font-semibold">ë§ì¶¤ ì¶”ì²œ</span></div>
                            </Card>
                        </div>

                        <div className="mt-4">
                            <Card className="p-6 text-center cursor-pointer bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:shadow-xl" onClick={onOpenRoutine}>
                                <div className="flex items-center justify-center gap-2"><I.spark /> <span className="font-semibold">ğŸ§´ ë§ì¶¤ ë£¨í‹´ ë¹Œë”</span></div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        }

        function ComparisonView({ onBack, reports, current }) {
            const radarRef = React.useRef(null);
            const lineRef = React.useRef(null);
            const radarChartRef = React.useRef(null);
            const lineChartRef = React.useRef(null);

            // 11ê°œ ìœ ì „ì ìˆœì„œ(í”„ë¡ íŠ¸/ì‹œíŠ¸ ê³µí†µ)
            const GENE_ORDER = ['PINK1', 'COL1A1', 'MSN', 'HAS2', 'FLG', 'AQP3', 'SPINK5', 'MLANA', 'TFAP2A', 'SOD1', 'VDR'];

            // í˜„ì¬ í™”ë©´ ë°ì´í„°(current)ì—ì„œ ìœ ì „ì ê°’ ë‚˜ì—´
            function getGeneSeriesFromCurrent() {
                if (!current) return Array(GENE_ORDER.length).fill(null);
                const v = {};
                ['aging', 'dryness', 'pigmentation'].forEach(cat => {
                    (current.biomarkers?.[cat] || []).forEach(m => { v[m.gene] = Number(m.value); });
                });
                return GENE_ORDER.map(g => (typeof v[g] === 'number' ? v[g] : null));
            }

            // ë¦¬í¬íŠ¸ë“¤ì—ì„œ (date, overallScore) ì‹œí€€ìŠ¤
            function getScoreTimeline() {
                const sorted = [...(reports || [])].sort((a, b) => String(a.date).localeCompare(String(b.date)));
                const labels = sorted.map(r => (r.date ? new Date(r.date).toLocaleDateString('ko-KR') : ''));
                const scores = sorted.map(r => Number(r.overallScore || 0));
                return { labels, scores };
            }

            React.useEffect(() => {
                // Radar
                const geneValues = getGeneSeriesFromCurrent();
                const ctxR = radarRef.current?.getContext('2d');
                if (ctxR) {
                    // ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ clean-up
                    if (radarChartRef.current) radarChartRef.current.destroy();
                    radarChartRef.current = new Chart(ctxR, {
                        type: 'radar',
                        data: {
                            labels: GENE_ORDER,
                            datasets: [{
                                label: 'í˜„ì¬ ë¶„ì„ (Î”Ct)',
                                data: geneValues,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: true,
                            scales: {
                                r: {
                                    angleLines: { display: true },
                                    suggestedMin: Math.min(...geneValues.filter(n => typeof n === 'number'), 0),
                                    suggestedMax: Math.max(...geneValues.filter(n => typeof n === 'number'), 10),
                                    ticks: { display: true }
                                }
                            },
                            plugins: {
                                legend: { display: true }
                            }
                        }
                    });
                }

                // Line
                const { labels, scores } = getScoreTimeline();
                const ctxL = lineRef.current?.getContext('2d');
                if (ctxL) {
                    if (lineChartRef.current) lineChartRef.current.destroy();
                    lineChartRef.current = new Chart(ctxL, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: 'ì¢…í•© ì ìˆ˜ ì¶”ì´',
                                data: scores,
                                tension: 0.25,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: true,
                            scales: {
                                y: { suggestedMin: 0, suggestedMax: 100 }
                            },
                            plugins: {
                                legend: { display: true }
                            }
                        }
                    });
                }

                // ì–¸ë§ˆìš´íŠ¸ ì‹œ ì •ë¦¬
                return () => {
                    if (radarChartRef.current) radarChartRef.current.destroy();
                    if (lineChartRef.current) lineChartRef.current.destroy();
                };
            }, [reports, current]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
                    <div className="max-w-4xl mx-auto p-4">
                        <Card className="p-6 mb-6">
                            <div className="flex items-center justify-between">
                                <button onClick={onBack} className="flex items-center gap-2 text-slate-600">
                                    <span className="rotate-180">â€º</span>
                                    <span>ë’¤ë¡œ</span>
                                </button>
                                <h1 className="text-xl font-bold text-slate-900">ğŸ“Š ë¹„êµ ë¶„ì„</h1>
                            </div>
                        </Card>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Card className="p-6">
                                <h4 className="font-bold text-slate-900 mb-3">ğŸ¯ ë ˆì´ë” ì°¨íŠ¸ (í˜„ì¬ ë¶„ì„)</h4>
                                <canvas ref={radarRef} height="260"></canvas>
                            </Card>

                            <Card className="p-6">
                                <h4 className="font-bold text-slate-900 mb-3">ğŸ“ˆ ì¢…í•© ì ìˆ˜ íƒ€ì„ë¼ì¸</h4>
                                <canvas ref={lineRef} height="260"></canvas>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        }

        /* ---------- ë¡œê·¸ì¸/íšŒì›ê°€ì… ---------- */
        function AuthView({ onAuthed }) {
            const [mode, setMode] = useState('login'); // 'login' | 'signup'
            const [email, setEmail] = useState('');
            const [name, setName] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');  // â¬…ï¸ ì¶”ê°€: ì—ëŸ¬ ë©”ì‹œì§€ ìƒíƒœ

            async function handleSubmit(e) {
                e.preventDefault();
                if (loading) return;
                setErrorMsg(''); // ì´ì „ ì—ëŸ¬ ì´ˆê¸°í™”
                try {
                    setLoading(true);
                    if (mode === 'signup') {
                        const user = await apiSignup({ email, name, password });
                        onAuthed(user);
                    } else {
                        const user = await apiLogin({ email, password });
                        onAuthed(user);
                    }
                } catch (err) {
                    const msg = String(err?.message || err || '');
                    // â¬‡ï¸ ì—ëŸ¬ ì½”ë“œì— ë”°ë¼ ì‚¬ìš©ì ì¹œí™”ì  ë¬¸êµ¬ ë…¸ì¶œ
                    if (msg === 'wrong_password') {
                        setErrorMsg('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else if (msg === 'no_such_email') {
                        setErrorMsg('ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
                    } else if (msg === 'missing_email_or_password') {
                        setErrorMsg('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    } else {
                        // ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ëŠ” ì•ˆë‚´ í›„ ìœ ì§€
                        alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                } finally {
                    setLoading(false);
                }
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 flex items-center justify-center p-4">
                    <Card className="w-full max-w-md p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h1 className="text-xl font-bold text-slate-900">{mode === 'signup' ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}</h1>
                            <button className="text-sm text-indigo-600" onClick={() => { setMode(mode === 'signup' ? 'login' : 'signup'); setErrorMsg(''); }}>
                                {mode === 'signup' ? 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸' : 'ì²˜ìŒì´ì‹ ê°€ìš”? íšŒì›ê°€ì…'}
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="flex items-center gap-2"><I.user /><input type="email" className="w-full border rounded-lg px-3 py-2" placeholder="ì´ë©”ì¼" value={email} onChange={e => setEmail(e.target.value)} required /></div>
                            {mode === 'signup' && (<div className="flex items-center gap-2"><I.bulb /><input type="text" className="w-full border rounded-lg px-3 py-2" placeholder="ì´ë¦„(ì„ íƒ)" value={name} onChange={e => setName(e.target.value)} /></div>)}
                            <div className="flex items-center gap-2"><I.key /><input type="password" className="w-full border rounded-lg px-3 py-2" placeholder="ë¹„ë°€ë²ˆí˜¸" value={password} onChange={e => setPassword(e.target.value)} required /></div>

                            {/* â¬‡ï¸ ì—¬ê¸°ì„œë§Œ ì¹œì ˆí•˜ê²Œ ì•ˆë‚´ (ì–¼ëŸ¿ X) */}
                            {errorMsg && <p className="text-sm text-rose-600 -mt-2">{errorMsg}</p>}

                            <button type="submit" className="w-full py-2.5 rounded-lg bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold disabled:opacity-60" disabled={loading}>
                                {loading ? 'ì²˜ë¦¬ ì¤‘â€¦' : (mode === 'signup' ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸')}
                            </button>
                        </form>
                    </Card>
                </div>
            );
        }

        /* ---------- App ë£¨íŠ¸ ---------- */
        function App() {
            const [user, setUser] = useState(() => {
                try { return JSON.parse(localStorage.getItem('user') || 'null'); } catch { return null; }
            });
            const [view, setView] = useState('reports');
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedReport, setSelectedReport] = useState(null);
            const [selectedGene, setSelectedGene] = useState(null);
            const [currentData, setCurrentData] = useState(SAMPLE_CURRENT_DATA);
            const [showNewModal, setShowNewModal] = useState(false);
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                if (!user) return;
                (async () => {
                    setLoading(true);
                    try {
                        const items = await apiGetReports(user.userId);
                        setReports(items);
                    } catch (e) {
                        alert('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + (e.message || String(e)));
                    } finally {
                        setLoading(false);
                    }
                })();
            }, [user]);

            function onAuthed(u) {
                localStorage.setItem('user', JSON.stringify(u));
                setUser(u);
            }
            function onLogout() {
                localStorage.removeItem('user');
                setUser(null);
                setReports([]);
                setView('reports');
            }

            async function handleCreateNew() {
                setShowNewModal(true);
            }

            async function saveNewAnalysis(withData) {
                if (saving) return;
                try {
                    setSaving(true);
                    setLoading(true);

                    // genes map
                    const genes = {};
                    ['aging', 'dryness', 'pigmentation'].forEach(cat => {
                        withData.biomarkers[cat].forEach(m => { genes[m.gene] = Number(m.value); });
                    });

                    const overall = calcOverallScoreFromSample(withData);
                    const now = new Date();
                    const yyyy = now.getFullYear();
                    const mm = String(now.getMonth() + 1).padStart(2, '0');
                    const dd = String(now.getDate()).padStart(2, '0');

                    const newRow = {
                        id: crypto.randomUUID(),
                        date: `${yyyy}-${mm}-${dd}`,
                        week: 0,
                        title: withData.title || 'ìƒˆ ë¶„ì„',
                        overallScore: overall,
                        status: 'completed',
                        ...genes,
                        userId: user.userId
                    };

                    await apiCreateReport(newRow);
                    const items = await apiGetReports(user.userId);
                    setReports(items);

                    setSelectedReport(newRow);
                    setCurrentData(buildDataFromReport({ ...newRow, genes }));
                    setView('analysis');

                    alert('ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (e) {
                    alert('ìƒˆ ë¶„ì„ ì €ì¥ ì‹¤íŒ¨: ' + (e.message || String(e)));
                } finally {
                    setLoading(false);
                    setSaving(false);
                    setShowNewModal(false);
                }
            }

            function openReport(r) {
                setSelectedReport(r);
                setCurrentData(buildDataFromReport(r));
                setView('analysis');
            }

            async function handleDelete() {
                if (!selectedReport) return;
                const ok = confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                if (!ok) return;
                try {
                    await apiDeleteReport(selectedReport.id, user.userId);
                    const items = await apiGetReports(user.userId);
                    setReports(items);
                    setSelectedReport(null);
                    setView('reports');
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (e) {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (e.message || String(e)));
                }
            }

            if (!user) return <AuthView onAuthed={onAuthed} />;

            return (
                <>
                    {view === 'reports' && (
                        <ReportsListView
                            reports={reports}
                            onOpenReport={openReport}
                            onOpenComparison={() => setView('comparison')}
                            onCreateNew={handleCreateNew}
                            loading={loading}
                            user={user}
                            onLogout={onLogout}
                        />
                    )}

                    {view === 'analysis' && (
                        <AnalysisResultView
                            data={currentData}
                            report={selectedReport}
                            onBack={() => setView('reports')}
                            onOpenComparison={() => setView('comparison')}
                            onOpenRecommendations={() => setView('recommendations')}
                            onOpenRoutine={() => setView('routine')}
                            onSelectGene={setSelectedGene}
                            onDelete={handleDelete}
                        />
                    )}

                    {view === 'comparison' && (
                        <ComparisonView
                            onBack={() => setView('reports')}
                            reports={reports}
                            current={currentData}
                        />
                    )}

                    {view === 'recommendations' && (
                        <RecommendationsView
                            onBack={() => setView('analysis')}
                            current={currentData}   // âœ… í˜„ì¬ ë¶„ì„ê°’ ì „ë‹¬
                        />
                    )}

                    {selectedGene && <GeneDetailModal gene={selectedGene} onClose={() => setSelectedGene(null)} />}

                    {showNewModal && (
                        <NewAnalysisModal
                            initialData={{ ...currentData, userId: user.userId }}
                            onCancel={() => setShowNewModal(false)}
                            onConfirm={saveNewAnalysis}
                            saving={saving}
                        />
                    )}
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>